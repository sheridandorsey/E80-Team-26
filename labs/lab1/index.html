<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.467">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>E80 SP24 - Lab 1: Go Autonomous</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">E80 SP24</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../lectures/"> 
<span class="menu-text">Lectures</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-labs" role="button" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Labs</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-labs">    
        <li>
    <a class="dropdown-item" href="../../labs/lab_overview">
 <span class="dropdown-text">Lab Overview</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../labs/lab0">
 <span class="dropdown-text">Lab 0: Tutorial &amp; Skills Review</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../labs/lab1">
 <span class="dropdown-text">Lab 1: Go Autonomous</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../labs/lab2">
 <span class="dropdown-text">Lab 2: BEM</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../labs/lab3">
 <span class="dropdown-text">Lab 3: Op-Amps</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../labs/lab4">
 <span class="dropdown-text">Lab 4: Temperature</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../labs/lab5">
 <span class="dropdown-text">Lab 5: Acoustics</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../labs/lab6">
 <span class="dropdown-text">Lab 6: Fluids</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../labs/lab7">
 <span class="dropdown-text">Lab 7: Navigation</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item">
    <a class="nav-link" href="../../project/"> 
<span class="menu-text">Project</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../reference/"> 
<span class="menu-text">Reference Designs</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../history/"> 
<span class="menu-text">History</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/HMC-E80/E80"> <i class="bi bi-github" role="img" aria-label="GitHub">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
          <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction"><span class="header-section-number">1</span> Introduction</a></li>
  <li><a href="#motherboard-assembly" id="toc-motherboard-assembly" class="nav-link" data-scroll-target="#motherboard-assembly"><span class="header-section-number">2</span> Motherboard Assembly</a></li>
  <li><a href="#motherboard-validation-imu-calibration-and-imu-error-measurement" id="toc-motherboard-validation-imu-calibration-and-imu-error-measurement" class="nav-link" data-scroll-target="#motherboard-validation-imu-calibration-and-imu-error-measurement"><span class="header-section-number">3</span> Motherboard Validation, IMU Calibration, and IMU Error Measurement</a></li>
  <li><a href="#penetrator-and-motor-assembly" id="toc-penetrator-and-motor-assembly" class="nav-link" data-scroll-target="#penetrator-and-motor-assembly"><span class="header-section-number">4</span> Penetrator and Motor Assembly</a></li>
  <li><a href="#auv-assembly" id="toc-auv-assembly" class="nav-link" data-scroll-target="#auv-assembly"><span class="header-section-number">5</span> AUV Assembly</a></li>
  <li><a href="#sec-experiment" id="toc-sec-experiment" class="nav-link" data-scroll-target="#sec-experiment"><span class="header-section-number">6</span> Open Loop Control Navigation</a></li>
  <li><a href="#acceleration-and-orientation-data" id="toc-acceleration-and-orientation-data" class="nav-link" data-scroll-target="#acceleration-and-orientation-data"><span class="header-section-number">7</span> Acceleration and Orientation Data</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Lab 1: Go Autonomous</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p>Team size: 4</p>
<p>Submission Sheet: <a href="../../labs/lab1/submission.html">html</a> <a href="../../labs/lab1/submission.docx">docx</a></p>
<p>Prelab Help Sheet: <a href="../../labs/lab1/prelab.html">html</a></p>
<p>Writing Assignment: <a href="../../labs/lab1/lab1-writing.html">html</a></p>
<section id="introduction" class="level2" data-number="1">
<h2 data-number="1" class="anchored" data-anchor-id="introduction"><span class="header-section-number">1</span> Introduction</h2>
<p>In this lab you will transform the ROV (remotely operated vehicle) used in E79 into an AUV (autonomous underwater vehicle). An ROV is controlled from the surface through long cables, but an AUV carries an autonomous controller on board. While the AUVs you build in Lab 1 will all look the same, you will have a chance to modify these vehicles during the project. By end of semester, each robot will be configured and equipped for unique ocean-sampling experiments.</p>
<p>After successful completion of this lab, you will be able to…</p>
<ul class="task-list">
<li><label><input type="checkbox">Perform some steps of modifying an E79 robot to build an E80 robot.</label></li>
<li><label><input type="checkbox">Program your robot to traverse basic trajectories.</label></li>
<li><label><input type="checkbox">Extract data from your robot, import it into Matlab, and plot it.</label></li>
<li><label><input type="checkbox">Use statistical measures to analyze data gathered from your robot.</label></li>
<li><label><input type="checkbox">Explain the limitations and challenges of open loop control.</label></li>
<li><label><input type="checkbox">Relate your robot’s behavior to governing equations from E79.</label></li>
</ul>
<p>Lab 1 is completed in teams of 4.</p>
<p>Be sure to read the <a href="../../labs/lab_overview/index.html">Lab Overview</a> to learn about safety requirements, expensive equipment handling and other rules. You must review all SAFETY QUESTION boxes below as part of prelab. If you ever reach a safety question box and either can’t answer it or feel unsure, grab an instructor.</p>
<p>At the end of the lab, you need to submit a completed submission sheet (see links above) on Canvas. Specifications for each part of the lab are included on the submission sheet.Recall that <strong>no late work is accepted</strong>, we will grade whatever is submitted before the deadlines. Since multiple submissions are allowed, you may want to submit a less-than-perfect draft early as insurance against missing the deadline.</p>
</section>
<section id="motherboard-assembly" class="level2" data-number="2">
<h2 data-number="2" class="anchored" data-anchor-id="motherboard-assembly"><span class="header-section-number">2</span> Motherboard Assembly</h2>
<p>A motherboard has been designed to interface the major electrical components of your AUV. Familiarize yourself with the components on the motherboard by reading the <a href="https://drive.google.com/file/d/18bMajGNwH1K2yHB1dQLZRx5eqrYiNQWA/view?usp=sharing">Introduction to the E80 Motherboard</a> document. You will add some necessary components to a partially constructed mother board in Lab 1. Use this <a href="https://docs.google.com/document/d/1v1vE3GXXUw8o6T2IJJws_xr_b3ntKiPx/edit?usp=sharing&amp;ouid=105511935419108795487&amp;rtpof=true&amp;sd=true">motherboard assembly document</a> as a guide and add the components. For reference, the schematic for the motherboard is <a href="https://drive.google.com/file/d/1pk_mORYsxhedKjjqzhMrxj9H5ZVH3zqp/view?usp=sharing">here</a> , the layout is <a href="https://drive.google.com/file/d/1pmm8xwpyAHAL5YvwMIQma4W8DuV-MP31/view?usp=sharing">here</a> , and <a href="https://www.kicad.org/">KiCAD</a> design files are <a href="https://drive.google.com/file/d/1pi9WNW7WoIx80xgb_0LWSUyA-LMfp94Z/view?usp=sharing">here</a>.</p>
<p>There are two ways that <strong>you can damage your motherboard irreparably</strong> during this process, and you should take precautions against each of them. One is soldering components in the wrong position or orientation (e.g., screw terminals facing inward or header on the back side of the board), which is very difficult to rework. Double check that you are using the correct header and try fitting all the pieces together before soldering. The other is flipping power and ground by attaching your battery or power supply leads backwards or soldering the red and black wires to the incorrect terminals on the motherboard. Have an instructor or proctor check your battery connector, and make sure to heed the warnings in the assembly guide.</p>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-1-contents" aria-controls="callout-1" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
SAFETY QUESTION: What are the two ways I can damage my board in this section?
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-1" class="callout-1-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Soldering components in the wrong position or orientation, and attaching battery or power supply leads backwards.</p>
</div>
</div>
</div>
<ol type="1">
<li>Find the parts you need for your motherboard in the parts rack on the supply table. There is set of parts racks in both B171 and B181.</li>
<li>Label your board: Before you begin assembly, <strong>write your section number, team number and board version on your board.</strong> This will be version 1 for all of you, you will increment your version if, for example, your board blows up and you have to make a new one.</li>
<li>Take precautions to keep everything working before soldering
<ol type="i">
<li>Double check that you are using the correct header and try fitting all the pieces together before soldering.</li>
<li>Have an instructor or proctor check your battery connector and power supply connector polarity.</li>
</ol></li>
<li>Follow the instructions in the <a href="https://docs.google.com/document/d/1v1vE3GXXUw8o6T2IJJws_xr_b3ntKiPx/edit?usp=sharing&amp;ouid=105511935419108795487&amp;rtpof=true&amp;sd=true">Motherboard Assembly Document</a> to build your Motherboard.</li>
<li>Cover the back of your motherboard with insulating foam sheet using these <a href="https://drive.google.com/open?id=1x0CMBDFia2uY5qxPkWFfg_pN3FcR7Pth">instructions</a> to prevent inadvertent short circuits when you set it down.</li>
<li>Find a sharpie and color the GND side of your P.S. screw black, so that you don’t forget the polarity of the connector.</li>
</ol>
</section>
<section id="motherboard-validation-imu-calibration-and-imu-error-measurement" class="level2" data-number="3">
<h2 data-number="3" class="anchored" data-anchor-id="motherboard-validation-imu-calibration-and-imu-error-measurement"><span class="header-section-number">3</span> Motherboard Validation, IMU Calibration, and IMU Error Measurement</h2>
<p>Your motherboard has a circuit on it called an inertial measurement unit (IMU), specifically an <a href="https://www.st.com/content/ccc/resource/technical/document/datasheet/74/c4/19/54/62/c5/46/13/DM00177685.pdf/files/DM00177685.pdf/jcr:content/translations/en.DM00177685.pdf">LSM303AGRTR</a> , which allows you to measure acceleration and magnetic fields. This is a useful sensor that we will explore more later in the course. We are just getting started with the sensor in this section by calibrating the output and measuring its noise statistics. This sensor is also useful because you can only measure its output if your motherboard is working correctly. The tests in this section will ensure that your Teensy can listen to the IMU, write to the SD card, and drive the motors.</p>
<p>First, test your motherboard:</p>
<ol type="1">
<li>Sign out an SD card from an instructor.</li>
<li>Put your Teensy and your SD card into your motherboard and program the Teensy with <code>E80_Lab_01.ino</code> from the E80 codebase from Github. This sketch will turn on one motor for four seconds if it is working properly, so be sure your motors are clear of any obstructions (especially your hands!) when you run the code.</li>
<li>Provide power to the Teensy using either your battery or the power supply terminals (be careful with the polarity!). You can use the power supply terminals if your battery is still charging. Several lights should turn on, including PWR LED, the IMU LED, the SD LED, and a small blinking LED on top of the Teensy.</li>
<li>You have the option of plugging in your USB cable so you can use the serial monitor to watch the Teensy’s serial output as it runs.</li>
<li>Remove power from your board (you do not need to remove the USB cable if it’s plugged in).</li>
<li>Take out the SD card and put it into your computer.</li>
<li>Take the INF and BIN files off of the SD card and read them according to the following instructions.
<ol type="i">
<li>The Teensy creates two files to save data every time it runs: an INF file which contains text and a BIN file which contains your measured data in a binary format.</li>
<li>Special programs are required to decode the binary data, and those programs also depend on having a matching INF file. We provide a MATLAB script for reading SD card data: <a href="https://github.com/HMC-E80/E80-SP2023/blob/main/MATLAB/logreader.m">logreader.m</a>.</li>
<li>These links provide <a href="https://drive.google.com/open?id=18-MICAN9QopCYHtpTnUVNme07YvaUmFD">sample INF</a> and <a href="https://drive.google.com/open?id=1h086niwvAh4C3Gs6r4vE12ZvaD1KYria">sample BIN</a> files so you can test the MATLAB scripts during prelab. The sample file is very noisy, so it can’t be used to find answers to the questions later in this Section.</li>
</ol></li>
<li>Verify that you are saving the following data to your SD card: acceleration values from your accelerometer, magnetic field strengths from your magnetometer, roll, pitch and yaw angles calculated from your IMU measurements, and motor PWM values.</li>
<li>Verify that your motherboard can drive motors by attaching motors to motor ports A, B and C, then modifying and running <code>E80_Lab_01.ino</code> (which you <a href="https://hmc-e80.github.io/E80/labs/lab0/#arduino-practice">set up in lab 0</a>) to drive each of them. If your motors are not ready, you can measure the voltages at screw terminals A, B and C to observe whether they are being correctly applied by your software.</li>
</ol>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Warning
</div>
</div>
<div class="callout-body-container callout-body">
<p>Please be very careful when connecting or disconnecting the micro USB cable to the Teensy!! Pull or push laterally while holding down the connector with your other hand. They are fragile and can be pulled off the board easily.</p>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>You can put your Teensy into programmer mode manually by pressing the button on top of the Teensy. This button won’t restart a program currently running on the Teensy. Instead, it deletes all the code on the Teensy so it can be reprogrammed. If you just want to rerun your current program, remove power from the Teensy (maybe using the black power rocker switch) and then restore power.</p>
</div>
</div>
<p>Second, analyze the data from your accelerometer:</p>
<ol type="1">
<li>Lay your board flat on its standoffs, then take ten seconds of accelerometer data. Determine the mean, the standard deviation, the standard error, and the 95% confidence bounds for a static acceleration measurement in the z direction.</li>
<li>Figure out the value the accelerometer reports when it is experiencing zero acceleration on each axis. You may need to run your program a few times while holding the board in different orientations to make each axis zero.</li>
<li>Use the acceleration due to gravity to figure out the size of one ‘accelerometer unit’ in your saved data: i.e.: if your accelerometer reports a value of 1, how many m/s^2 of acceleration is the accelerometer experiencing?</li>
<li>Use the Student’s T Test to determine if the zero values on each of your axes are statistically different from one another.</li>
</ol>
</section>
<section id="penetrator-and-motor-assembly" class="level2" data-number="4">
<h2 data-number="4" class="anchored" data-anchor-id="penetrator-and-motor-assembly"><span class="header-section-number">4</span> Penetrator and Motor Assembly</h2>
<p>In E80 we use special bolts to make waterproof electrical connections across a robot (<a href="#fig-penetrator-bolt" class="quarto-xref">Figure&nbsp;1 (a)</a>), and we refer to them as penetrators. Penetrators are combined with a nut and gasket (<a href="#fig-nut-and-gasket" class="quarto-xref">Figure&nbsp;1 (b)</a>) to make waterproof seals on project boxes (<a href="#fig-project-box-with-penetrator-bolt" class="quarto-xref">Figure&nbsp;1 (c)</a>). This figure shows two important details about using penetrator bolts: the threads must point INTO the box and the washer must be OUTSIDE the box.</p>
<div id="fig-penetrators" class="quarto-layout-panel">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-penetrators-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="quarto-layout-row quarto-layout-valign-top">
<div class="quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-penetrators" style="flex-basis: 33.3%;justify-content: center;">
<div id="fig-penetrator-bolt" class="quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-penetrator-bolt-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="img/penetrator-bolt.jpg" class="img-fluid figure-img" data-ref-parent="fig-penetrators">
</div>
<figcaption class="figure quarto-subfloat-caption quarto-subfloat-fig" id="fig-penetrator-bolt-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(a) Penetrator bolt.
</figcaption>
</figure>
</div>
</div>
<div class="quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-penetrators" style="flex-basis: 33.3%;justify-content: center;">
<div id="fig-nut-and-gasket" class="quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-nut-and-gasket-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="img/penetrator-bolt-with-nut.jpg" class="img-fluid figure-img" data-ref-parent="fig-penetrators">
</div>
<figcaption class="figure quarto-subfloat-caption quarto-subfloat-fig" id="fig-nut-and-gasket-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(b) Penetrator nut and gasket.
</figcaption>
</figure>
</div>
</div>
<div class="quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-penetrators" style="flex-basis: 33.3%;justify-content: center;">
<div id="fig-project-box-with-penetrator-bolt" class="quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-project-box-with-penetrator-bolt-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="img/project-box-with-penetrator-bolt.jpg" class="img-fluid figure-img" data-ref-parent="fig-penetrators">
</div>
<figcaption class="figure quarto-subfloat-caption quarto-subfloat-fig" id="fig-project-box-with-penetrator-bolt-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(c) Project box with penetrator bolt assembly.
</figcaption>
</figure>
</div>
</div>
</div>
</div>
<figcaption class="figure quarto-float-caption quarto-float-fig" id="fig-penetrators-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;1: Project box and penetrator bolt details
</figcaption>
</figure>
</div>
<p>These penetrators have six wires passing through them because your AUV will use three motors, which you must prepare.</p>
<ol type="1">
<li>You will need a total of 3 motors. If necessary, you can prep new motors as you did in E79, but your time will be very limited if you must build motors. Instructions can be found <a href="https://sites.google.com/g.hmc.edu/e79-practicum/module-1/practicum-1a">here</a>.</li>
<li>If you have not done so during Lab 0, test your motors using a power supply to make sure they work by supplying 6VDC:
<ol type="i">
<li>If the current draw during this test is more than 500 mA, then the friction in your motor is likely to severely limit your top speed; consider debugging it.<br>
</li>
<li>Selecting motors that have similar current draws may simplify your software because the motors will exert similar thrusts at the same level of applied PWM.</li>
<li>Make sure your motors still work when they are submerged in water.</li>
</ol></li>
<li>Solder the leads of your three motors. Your motors will be OUTSIDE of the box, so your solder joints will need to be waterproofed with heat shrink tuing. After putting heat shrink on your wires, solder the motor leads to the twisted pair on the non-threaded side of your penetrator bolt. Finish Waterproofing your solder joints with heat shrink tubing.</li>
<li>Test that all three motors work when the waterproofed solder joints are underwater.</li>
</ol>
</section>
<section id="auv-assembly" class="level2" data-number="5">
<h2 data-number="5" class="anchored" data-anchor-id="auv-assembly"><span class="header-section-number">5</span> AUV Assembly</h2>
<p>First, assemble your project box:</p>
<ol type="1">
<li>Find your waterproof box and remove the protective paper tape on the rubber seal.</li>
<li>Drill out your penetrator holes using a step drill bit. <em>DO NOT USE A NORMAL DRILL BIT</em>. Pictures of a step drill bit and the drilling process are in <a href="#fig-step-bit" class="quarto-xref">Figure&nbsp;2 (a)</a> and <a href="#fig-step-drill-use" class="quarto-xref">Figure&nbsp;2 (b)</a> . The inner diameter of your hole should be 0.5 inches.</li>
<li>Attach your penetrator and motor assembly to the box (remember threads are in and washer is on the outside). This is pictured in <a href="#fig-penetrator-in-box" class="quarto-xref">Figure&nbsp;2 (c)</a></li>
<li>Hold your box and penetrator combination underwater to check for leaks. DON’T perform this test with any electronics or batteries in the box.</li>
<li>If you find leaks, fix them before proceeding. Ask for help if you’re stuck.</li>
</ol>
<div id="fig-step-drill" class="quarto-layout-panel">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-step-drill-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="quarto-layout-row quarto-layout-valign-top">
<div class="quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-step-drill" style="flex-basis: 33.3%;justify-content: center;">
<div id="fig-step-bit" class="quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-step-bit-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="img/step_drill_bit.jpg" class="img-fluid figure-img" data-ref-parent="fig-step-drill">
</div>
<figcaption class="figure quarto-subfloat-caption quarto-subfloat-fig" id="fig-step-bit-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(a) A step drill bit.
</figcaption>
</figure>
</div>
</div>
<div class="quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-step-drill" style="flex-basis: 33.3%;justify-content: center;">
<div id="fig-step-drill-use" class="quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-step-drill-use-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="img/using_step_drill.jpg" class="img-fluid figure-img" data-ref-parent="fig-step-drill">
</div>
<figcaption class="figure quarto-subfloat-caption quarto-subfloat-fig" id="fig-step-drill-use-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(b) How to use a step drill bit to drill a hole.
</figcaption>
</figure>
</div>
</div>
<div class="quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-step-drill" style="flex-basis: 33.3%;justify-content: center;">
<div id="fig-penetrator-in-box" class="quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-penetrator-in-box-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="img/penetrator_in_box_lab1.jpg" class="img-fluid figure-img" data-ref-parent="fig-step-drill">
</div>
<figcaption class="figure quarto-subfloat-caption quarto-subfloat-fig" id="fig-penetrator-in-box-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(c) An example penetrator installed in a project box.
</figcaption>
</figure>
</div>
</div>
</div>
</div>
<figcaption class="figure quarto-float-caption quarto-float-fig" id="fig-step-drill-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;2: Information on drilling and assembling your project box.
</figcaption>
</figure>
</div>
<p>Second, assemble your robot:</p>
<ol type="1">
<li>Dry your box and place your battery, motherboard and Teensy into the box. See <a href="#fig-board-in-box" class="quarto-xref">Figure&nbsp;3 (a)</a>.</li>
<li>Use Velcro to attach the box to a PVC robot frame. Make sure to attach a plastic cargo mesh on the bottom of your frame for carrying payloads. See <a href="#fig-box-on-frame" class="quarto-xref">Figure&nbsp;3 (b)</a>.</li>
<li>Use zip ties to secure the cargo mesh to the robot frame.</li>
</ol>
<div id="fig-assembly" class="quarto-layout-panel">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-assembly-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="quarto-layout-row quarto-layout-valign-top">
<div class="quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-assembly" style="flex-basis: 50.0%;justify-content: center;">
<div id="fig-board-in-box" class="quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-board-in-box-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="img/board_in_box_lab1.jpg" class="img-fluid figure-img" data-ref-parent="fig-assembly">
</div>
<figcaption class="figure quarto-subfloat-caption quarto-subfloat-fig" id="fig-board-in-box-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(a) A board and battery wired into a project box.
</figcaption>
</figure>
</div>
</div>
<div class="quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-assembly" style="flex-basis: 50.0%;justify-content: center;">
<div id="fig-box-on-frame" class="quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-box-on-frame-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="img/box_on_frame_v2.jpg" class="img-fluid figure-img" data-ref-parent="fig-assembly">
</div>
<figcaption class="figure quarto-subfloat-caption quarto-subfloat-fig" id="fig-box-on-frame-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(b) A box velcroed to a frame with a cargo mesh.
</figcaption>
</figure>
</div>
</div>
</div>
</div>
<figcaption class="figure quarto-float-caption quarto-float-fig" id="fig-assembly-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3: Pictures of your board and robot assembly.
</figcaption>
</figure>
</div>
<p>Third, ballast your robot so that it is close to neutrally buoyant.</p>
<ol type="1">
<li>Determine how much mass to add. To do this, it helps to know the mass of your robot, and that the robot (including motors and two 1.25’’ foam blocks, but not including the watertight box) has a buoyancy force measured to be approximately 10 N. You can do this approximately in prelab with a guess at your robot’s mass.</li>
<li>Select weights for ballasting. Pictures of some of the weights we have available are in <a href="#fig-loose-ballast" class="quarto-xref">Figure&nbsp;4 (a)</a>. Be mindful that their distribution inside of your payload box could affect the resting pitch, yaw or roll of the robot. It may be useful to adjust the resting buoyancy, pitch, yaw, and roll of your robot with the waterproof box before attempting the obstacle course in section 7.</li>
<li>Protect against metal shorts. Many of the weights we use are metal, so they can short the back of your motherboard. Make sure the back of your motherboard is covered with insulating foam or electrical tape before setting it on top of your ballast. We also recommend wrapping your ballast in plastic wrap as shown in <a href="#fig-wrapped_ballast" class="quarto-xref">Figure&nbsp;4 (b)</a>.</li>
</ol>
<div id="fig-ballast" class="quarto-layout-panel">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-ballast-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="quarto-layout-row quarto-layout-valign-top">
<div class="quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-ballast" style="flex-basis: 50.0%;justify-content: center;">
<div id="fig-loose-ballast" class="quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-loose-ballast-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="img/ballast.jpg" class="img-fluid figure-img" data-ref-parent="fig-ballast">
</div>
<figcaption class="figure quarto-subfloat-caption quarto-subfloat-fig" id="fig-loose-ballast-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(a) Loose ballast in the corner of the lab.
</figcaption>
</figure>
</div>
</div>
<div class="quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-ballast" style="flex-basis: 50.0%;justify-content: center;">
<div id="fig-wrapped_ballast" class="quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-wrapped_ballast-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="img/wrapped_ballast.jpg" class="img-fluid figure-img" data-ref-parent="fig-ballast">
</div>
<figcaption class="figure quarto-subfloat-caption quarto-subfloat-fig" id="fig-wrapped_ballast-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(b) Ballast wrapped in insulating plastic.
</figcaption>
</figure>
</div>
</div>
</div>
</div>
<figcaption class="figure quarto-float-caption quarto-float-fig" id="fig-ballast-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4: Reference images for finding and using ballast.
</figcaption>
</figure>
</div>
</section>
<section id="sec-experiment" class="level2" data-number="6">
<h2 data-number="6" class="anchored" data-anchor-id="sec-experiment"><span class="header-section-number">6</span> Open Loop Control Navigation</h2>
<p>A simple obstacle course will be set up in the test tank. The obstacle course is pictures in <a href="#fig-obstacle-1" class="quarto-xref">Figure&nbsp;5</a> and <a href="#fig-obstacles" class="quarto-xref">Figure&nbsp;6</a>. You must navigate your robot through the 3 hoops, starting at the surface in one hoop, diving through the second and surfacing in the third.</p>
<div id="fig-obstacle-1" class="quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-obstacle-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="img/lab1_obstacle_course.png" class="img-fluid figure-img">
</div>
<figcaption class="figure quarto-float-caption quarto-float-fig" id="fig-obstacle-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5: Diagram of obstacle course.
</figcaption>
</figure>
</div>
<div id="fig-obstacles" class="quarto-layout-panel">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-obstacles-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="quarto-layout-row quarto-layout-valign-top">
<div class="quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-obstacles" style="flex-basis: 50.0%;justify-content: center;">
<div id="fig-obstacle-2" class="quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-obstacle-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="img/Lab1_obs.1.jpg" class="img-fluid figure-img" data-ref-parent="fig-obstacles">
</div>
<figcaption class="figure quarto-subfloat-caption quarto-subfloat-fig" id="fig-obstacle-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(a) Over water view of obstacle course.
</figcaption>
</figure>
</div>
</div>
<div class="quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-obstacles" style="flex-basis: 50.0%;justify-content: center;">
<div id="fig-obstacle-3" class="quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-obstacle-3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="img/Lab1_obs.2.jpg" class="img-fluid figure-img" data-ref-parent="fig-obstacles">
</div>
<figcaption class="figure quarto-subfloat-caption quarto-subfloat-fig" id="fig-obstacle-3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(b) Underwater view of obstacle course.
</figcaption>
</figure>
</div>
</div>
</div>
</div>
<figcaption class="figure quarto-float-caption quarto-float-fig" id="fig-obstacles-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;6: Project box and penetrator bolt details
</figcaption>
</figure>
</div>
<ol type="1">
<li>Modify <code>E80_Lab_01.ino</code> to direct your robot to traverse the course so that it ends within the red hoop (3). You can assume your AUV can start in the middle of the yellow hoop (1). Make sure your code accounts for the time you will need to seal up the waterproof box, attach it to the robot frame, and position it in the water.</li>
<li>Be sure to test your code with your robot ahead of time, in air and in a dunk tank, before you visit the test tank room. It is important to know how to control each motor, including which direction each motor turns. It is also important to verify that you are correctly logging data.</li>
<li>Get your robot checked by an instructor, go to the tank room, and deploy your robot. You will only have 5 attempts in the test tank room.</li>
</ol>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Part of the goal of this lab is to convince you that open loop control does not work very well. Robots navigating open loop can go off course because of motor behaviors, currents in the tank, misplacement in the launch area, or many other reasons. Closed loop control can address some of these issues. Don’t worry if your robot doesn’t complete the obstacle course.</p>
</div>
</div>
</section>
<section id="acceleration-and-orientation-data" class="level2" data-number="7">
<h2 data-number="7" class="anchored" data-anchor-id="acceleration-and-orientation-data"><span class="header-section-number">7</span> Acceleration and Orientation Data</h2>
<p>Plot the AUV acceleration data from the experiment in <a href="#sec-experiment" class="quarto-xref">Section&nbsp;6</a> as a function of sample number. Confirm that positive acceleration is in the correct direction. Confirm qualitatively whether the measured acceleration data matches your expectations, and retake data if needed.</p>
<p>Finally, consider the E79 robot model in <a href="#eq-e79" class="quarto-xref">Equation&nbsp;1</a> and the E79 motor thrust curve in <a href="#fig-thrust-curve" class="quarto-xref">Figure&nbsp;7</a>. Use the model and the thrust curve to make predictions of your peak acceleration when your motors first turn on from rest. Compare that prediction to your measured data.</p>
<p><span id="eq-e79"><span class="math display">\[ m\ddot{x} = F_{thrust} - b\dot{x} \tag{1}\]</span></span></p>
<div id="fig-thrust-curve" class="quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-thrust-curve-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="img/ThrustCurve4.png" class="img-fluid figure-img">
</div>
<figcaption class="figure quarto-float-caption quarto-float-fig" id="fig-thrust-curve-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;7: Thrust curve for E79 motor.
</figcaption>
</figure>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>This comparison is a good example of how E79 can be applied and a good example of how to compare experimental data to theory. The comparison also can be affected by differences between your motors compared and this motor curve, and that variability makes another case for using closed loop control.</p>
</div>
</div>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Warning
</div>
</div>
<div class="callout-body-container callout-body">
<p><strong>IMPORTANT CLEANUP</strong>: Please return the battery charger to the center table. These will be shared among the different lab sections. Also, put your ballast weights, board, Teensy, penetrator bolt (with motors), battery and robot frame in your labelled Tupperware container in the cupboard. Please return SD card and SD card reader to the proctor or Lynn.</p>
</div>
</div>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    const typesetMath = (el) => {
      if (window.MathJax) {
        // MathJax Typeset
        window.MathJax.typeset([el]);
      } else if (window.katex) {
        // KaTeX Render
        var mathElements = el.getElementsByClassName("math");
        var macros = [];
        for (var i = 0; i < mathElements.length; i++) {
          var texText = mathElements[i].firstChild;
          if (mathElements[i].tagName == "SPAN") {
            window.katex.render(texText.data, mathElements[i], {
              displayMode: mathElements[i].classList.contains('display'),
              throwOnError: false,
              macros: macros,
              fleqn: false
            });
          }
        }
      }
    }
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        for (let i = 0; i < 2; i++) {
          container.appendChild(note.children[i].cloneNode(true));
        }
        typesetMath(container);
        return container.innerHTML
      } else {
        typesetMath(note);
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      typesetMath(note);
      return note.innerHTML;
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>